var __reflect=this&&this.__reflect||function(e,t,r){e.__class__=t,r?r.push(t):r=[t],e.__types__=e.__types__?r.concat(e.__types__):r},__extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);r.prototype=t.prototype,e.prototype=new r},__decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=3>i?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(3>i?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},RES;!function(e){}(RES||(RES={}));var RES;!function(e){var t=function(){function t(){this.groupTotalDic={},this.numLoadedDic={},this.groupErrorDic={},this.retryTimesDic={},this.maxRetryTimes=3,this.reporterDic={},this.dispatcherDic={},this.failedList=new Array,this.loadItemErrorDic={},this.errorDic={},this.itemListPriorityDic={},this.itemLoadDic={},this.promiseHash={},this.lazyLoadList=new Array,this.loadingCount=0,this.thread=4}return t.prototype.pushResItem=function(e){if(this.promiseHash[e.name])return this.promiseHash[e.name];this.lazyLoadList.push(e),this.itemListPriorityDic[Number.NEGATIVE_INFINITY]=this.lazyLoadList,this.updatelistPriority(this.lazyLoadList,Number.NEGATIVE_INFINITY);var t=new egret.EventDispatcher;this.dispatcherDic[e.name]=t;var r=new Promise(function(e,r){t.addEventListener("complete",function(t){e(t.data)},null),t.addEventListener("error",function(e){r(e.data)},null)});return this.promiseHash[e.name]=r,this.loadNextResource(),r},t.prototype.pushResGroup=function(e,t,r,o){if(this.promiseHash[t])return this.promiseHash[t];for(var n=e.length,i=0;n>i;i++){var s=e[i];s.groupNames||(s.groupNames=[]),s.groupNames.push(t)}this.groupTotalDic[t]=e.length,this.numLoadedDic[t]=0,this.updatelistPriority(e,r),this.reporterDic[t]=o;var a=new egret.EventDispatcher;this.dispatcherDic[t]=a;var u=new Promise(function(e,t){a.addEventListener("complete",e,null),a.addEventListener("error",function(e){t(e.data)},null)});return this.promiseHash[t]=u,this.loadNextResource(),u},t.prototype.updatelistPriority=function(e,t){void 0==this.itemListPriorityDic[t]&&(this.itemListPriorityDic[t]=[]);for(var r=0,o=e;r<o.length;r++){var n=o[r];if(1!=this.itemLoadDic[n.name]){var i=this.findPriorityInDic(n);if(void 0==i)this.itemListPriorityDic[t].push(n);else if(t>i){this.itemListPriorityDic[t].push(n);var s=this.itemListPriorityDic[i].indexOf(n);this.itemListPriorityDic[i].splice(s,1)}}}},t.prototype.findPriorityInDic=function(e){for(var t in this.itemListPriorityDic)if(this.itemListPriorityDic[t].indexOf(e)>-1)return parseInt(t)},t.prototype.loadNextResource=function(){for(;this.loadingCount<this.thread;){var e=this.loadSingleResource();if(!e)break}},t.prototype.loadSingleResource=function(){var t=this,r=this.getOneResourceInfoInGroup();return r?(this.itemLoadDic[r.name]=1,this.loadingCount++,this.loadResource(r).then(function(o){if(t.loadingCount--,delete t.itemLoadDic[r.name],e.host.save(r,o),t.promiseHash[r.name]){var n=t.deleteDispatcher(r.name);n.dispatchEventWith("complete",!1,o)}var i=r.groupNames;if(i){delete r.groupNames;for(var s=0,a=i;s<a.length;s++){var u=a[s];t.setGroupProgress(u,r)&&t.loadGroupEnd(u)}}t.loadNextResource()})["catch"](function(o){if(!o)throw r.name+" load fail";if(!o.__resource_manager_error__)throw o;delete t.itemLoadDic[r.name],t.loadingCount--,delete e.host.state[r.root+r.name];var n=t.retryTimesDic[r.name]||1;if(!(n>t.maxRetryTimes))return t.retryTimesDic[r.name]=n+1,t.failedList.push(r),void t.loadNextResource();if(delete t.retryTimesDic[r.name],t.promiseHash[r.name]){var i=t.deleteDispatcher(r.name);i.dispatchEventWith("error",!1,{r:r,error:o})}var s=r.groupNames;if(s){delete r.groupNames;for(var a=0,u=s;a<u.length;a++){var c=u[a];t.loadItemErrorDic[c]||(t.loadItemErrorDic[c]=[]),-1==t.loadItemErrorDic[c].indexOf(r)&&t.loadItemErrorDic[c].push(r),t.groupErrorDic[c]=!0,t.setGroupProgress(c,r)?t.loadGroupEnd(c,o):t.errorDic[c]=o}}t.loadNextResource()}),!0):!1},t.prototype.getOneResourceInfoInGroup=function(){if(this.failedList.length>0)return this.failedList.shift();var e=Number.NEGATIVE_INFINITY;for(var t in this.itemListPriorityDic)e=Math.max(e,t);var r=this.itemListPriorityDic[e];if(r)return 0==r.length?(delete this.itemListPriorityDic[e],this.getOneResourceInfoInGroup()):r.shift()},t.prototype.setGroupProgress=function(e,t){var r=this.reporterDic[e];this.numLoadedDic[e]++;var o=this.numLoadedDic[e],n=this.groupTotalDic[e];return r&&r.onProgress&&r.onProgress(o,n,t),o==n},t.prototype.loadGroupEnd=function(e,t){delete this.groupTotalDic[e],delete this.numLoadedDic[e],delete this.reporterDic[e];var r=this.deleteDispatcher(e);if(t){delete this.groupErrorDic[e];var o=this.loadItemErrorDic[e];delete this.loadItemErrorDic[e],r.dispatchEventWith("error",!1,{itemList:o,lastError:t})}else{var n=this.groupErrorDic[e];if(delete this.groupErrorDic[e],n){var o=this.loadItemErrorDic[e];delete this.loadItemErrorDic[e];var i=this.errorDic[e];delete this.errorDic[e],r.dispatchEventWith("error",!1,{itemList:o,error:i})}else r.dispatchEventWith("complete")}},t.prototype.deleteDispatcher=function(e){delete this.promiseHash[e];var t=this.dispatcherDic[e];return delete this.dispatcherDic[e],t},t.prototype.loadResource=function(t,r){if(!r){if(1==e.FEATURE_FLAG.FIX_DUPLICATE_LOAD){var o=e.host.state[t.root+t.name];if(2==o)return Promise.resolve(e.host.get(t));if(1==o)return t.promise}r=e.processor.isSupport(t)}if(!r)throw new e.ResourceManagerError(2001,t.name,t.type);e.host.state[t.root+t.name]=1;var n=r.onLoadStart(e.host,t);return t.promise=n,n},t.prototype.unloadResource=function(t){var r=e.host.get(t);if(!r)return console.warn("尝试释放不存在的资源:",t.name),!1;var o=e.processor.isSupport(t);return o?(o.onRemoveStart(e.host,t),e.host.remove(t),1==t.extra&&e.config.removeResourceData(t),!0):!0},t}();e.ResourceLoader=t,__reflect(t.prototype,"RES.ResourceLoader")}(RES||(RES={}));var RES;!function(e){e.checkNull=function(e,t,r){var o=r.value;r.value=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e[0]?o.apply(this,e):(console.warn("方法"+t+"的参数不能为null"),null)}},e.FEATURE_FLAG={FIX_DUPLICATE_LOAD:1};var t;!function(e){function t(e){r=e}var r="warning";e.setUpgradeGuideLevel=t}(t=e.upgrade||(e.upgrade={}))}(RES||(RES={}));var RES;!function(e){function t(t){var r=e.config.config.fileSystem.getFile(t);return r||(t=e.resourceNameSelector(t),r=e.config.config.fileSystem.getFile(t)),r}function r(e,t){var r;r=e.indexOf(".json")>=0?"legacyResourceConfig":"resourceConfig",o={type:r,root:t,url:e,name:e}}e.resourceNameSelector=function(e){return e},e.getResourceInfo=t;var o;e.setConfigURL=r;var n=function(){function r(){}return r.prototype.init=function(){return this.config||(this.config={alias:{},groups:{},resourceRoot:o.root,typeSelector:function(){return"unknown"},mergeSelector:null,fileSystem:null,loadGroup:[]}),e.queue.pushResItem(o)["catch"](function(t){return t.__resource_manager_error__||(console.error(t.stack),t=new e.ResourceManagerError(1002)),e.host.remove(o),Promise.reject(t)})},r.prototype.getGroupByName=function(t,r){var o=this.config.groups[t],n=[];if(!o){if(r)throw new e.ResourceManagerError(2005,t);return null}for(var i=0,s=o;i<s.length;i++){var a=s[i],u=e.config.getResourceWithSubkey(a,!0),c=u.key,l=(u.subkey,e.config.getResource(c,!0));-1==n.indexOf(l)&&n.push(l)}return n},r.prototype.__temp__get__type__via__url=function(t){var r=this.config.alias[t];if(r||(r=t),e.resourceTypeSelector){var o=e.resourceTypeSelector(r);if(!o)throw new e.ResourceManagerError(2004,r);return o}return console.warn("RES.mapConfig 并未设置 typeSelector"),"unknown"},r.prototype.getResourceWithSubkey=function(t,r){t=this.getKeyByAlias(t);var o=t.indexOf("#"),n="";o>=0&&(n=t.substr(o+1),t=t.substr(0,o));var i=this.getResource(t);if(i)return{r:i,key:t,subkey:n};if(r){var s=n?t+"#"+n:t;throw new e.ResourceManagerError(2006,s)}return null},r.prototype.getKeyByAlias=function(e){return this.config.alias[e]?this.config.alias[e]:e},r.prototype.getResource=function(r,o){var n=this.config.alias[r];n||(n=r);var i=t(n);if(!i){if(o)throw new e.ResourceManagerError(2006,r);return null}return i},r.prototype.getGroup=function(e){return this.getGroupByName(e)},r.prototype.createGroup=function(e,t,r){if(void 0===r&&(r=!1),!r&&this.config.groups[e]||!t||0==t.length)return!1;for(var o=[],n=0,i=t;n<i.length;n++){var s=i[n];if(this.config.groups[s]){var a=this.config.groups[s];o=o.concat(a)}else o.push(s)}return this.config.groups[e]=o,!0},r.prototype.addSubkey=function(e,t){this.addAlias(e,t+"#"+e)},r.prototype.addAlias=function(e,t){this.config.alias[t]&&(t=this.config.alias[t]),this.config.alias[e]=t},r.prototype.getType=function(e){return this.getResource(e,!0).type},r.prototype.addResourceData=function(t){e.hasRes(t.name)||(t.type||(t.type=this.__temp__get__type__via__url(t.url)),e.config.config.fileSystem.addFile(t.url,t.type,t.root,t.extra),t.name&&(this.config.alias[t.name]=t.url))},r.prototype.removeResourceData=function(t){e.hasRes(t.name)&&(e.config.config.fileSystem.removeFile(t.url),this.config.alias[t.name]&&delete this.config.alias[t.name])},r}();e.ResourceConfig=n,__reflect(n.prototype,"RES.ResourceConfig")}(RES||(RES={}));var RES;!function(e){function t(e,t){return e.priority==t.priority?e.time-t.time:e.priority-t.priority}function r(t,r,o){void 0===o&&(o=0),this.getDispatcher(t,o).once(egret.Event.COMPLETE,function(o){var n=e.config.getResourceWithSubkey(t,!0),i=n.key,s=n.r,a=n.subkey,u=e.processor.isSupport(s);r(u&&u.getData&&a?u.getData(e.host,s,i,a):o.data)},null)}function o(r,o){void 0===o&&(o=0);var n=e.config.getResourceWithSubkey(r,!0),i=e.lazyLoadMap[n.key];null!=i&&i.dispatcher&&e.lazyLoadList.indexOf(i)>=0&&(i.priority=o,e.lazyLoadList.sort(t))}function n(r,o){void 0===o&&(o=0);var n=e.config.getResourceWithSubkey(r,!0),s=e.lazyLoadMap[n.key];return null==s&&(s=new g(r,o),e.lazyLoadMap[n.key]=s),s.dispatcher||(s.time=egret.getTimer(),s.dispatcher=new egret.EventDispatcher,e.lazyLoadList.indexOf(s)>=0?egret.error("duplicate "+r+" "+n.key):(e.lazyLoadList.push(s),e.lazyLoadList.sort(t)),e.loadingCount<e.maxThread&&egret.callLater(i,null)),s.dispatcher}function i(){for(var t=function(){if(e.lazyLoadList.length<=0)return"break";var t=e.lazyLoadList.pop();if(t.dispatcher){e.loadingCount++;var r=e.config.getResourceWithSubkey(t.url,!0),o=r.key,n=r.r;r.subkey;e.queue.pushResItem(n).then(function(t){e.host.save(n,t),e.loadingCount--;var r=e.lazyLoadMap[o].dispatcher;r?(e.lazyLoadMap[o].dispatcher=void 0,r.dispatchEventWith(egret.Event.COMPLETE,!1,t,!1)):egret.error(o+" dispatcher is undefined"),e.recycles[o]&&(e.recycles[o]=egret.getTimer()+~~(e.cacheDuration/2)),egret.callLater(i,null)},function(){e.loadingCount--;var t=e.lazyLoadMap[o].dispatcher;t?(e.lazyLoadMap[o].dispatcher=void 0,t.dispatchEventWith(egret.IOErrorEvent.IO_ERROR)):egret.error(o+" dispatcher is undefined"),e.lazyLoadMap[o].dispatcher=void 0,e.host.state[n.root+n.name]=0,egret.callLater(i,null)})}};e.loadingCount<e.maxThread;){var r=t();if("break"===r)break}}function s(t){var r=e.config.getResourceWithSubkey(t,!0).key;e.using[r]||(null!=e.recycles[r]&&delete e.recycles[r],e.using[r]=0),e.using[r]++}function a(t,r){void 0===r&&(r=e.cacheDuration);var o=e.config.getResourceWithSubkey(t,!0).key;u(o,1,r)}function u(t,r,o){var n=e.getState(t);if(e.using[t]){if(e.using[t]-=r,e.using[t]<=0)switch(e.using[t]=0,n){case 1:case 2:var i=e.recycles[t]||0;e.recycles[t]=Math.max(i,egret.getTimer()+o);break;default:var s=e.lazyLoadMap[t];if(!s)return;if(s.dispatcher){var a=e.lazyLoadList.indexOf(s);a>=0&&(e.lazyLoadList.splice(a,1),s.dispatcher=void 0)}}}else switch(egret.error("remove resource fail not found "+t),n){case 1:e.recycles[t]=egret.getTimer();break;case 2:e.destroyRes(t)}}function c(e){setInterval(l,e)}function l(){var t=egret.getTimer();for(var r in e.recycles)t>=e.recycles[r]&&f(r)}function f(t){switch(e.getState(t)){case 2:e.destroyRes(t),delete e.recycles[t];break;case 0:case 3:delete e.recycles[t]}}function p(t){var r=egret.getTimer()+t;for(var o in e.recycles)r>=e.recycles[o]&&f(o)}e.cacheDuration=3e4;var h=function(){function t(){this.retry=0}return t.prototype.get=function(t,r,o){void 0===o&&(o=0),e.addRel(t),this.url=t;var n=e.getRes(t);null!=n?r(n):(this.retry=0,this.dispatcher=e.getDispatcher(t,o),this.handle=r,this.dispatcher.once(egret.Event.COMPLETE,this.onEvent,this),this.dispatcher.once(egret.IOErrorEvent.IO_ERROR,this.onError,this))},t.prototype.onEvent=function(t){if(this.dispatcher&&this.dispatcher.removeEventListener(egret.IOErrorEvent.IO_ERROR,this.onError,this),this.handle){var r=e.config.getResourceWithSubkey(this.url,!0),o=r.key,n=r.r,i=r.subkey,s=e.processor.isSupport(n);s&&s.getData&&i?this.handle(s.getData(e.host,n,o,i)):this.handle(t.data),this.handle=void 0}},t.prototype.onError=function(){this.dispatcher&&this.dispatcher.removeEventListener(egret.Event.COMPLETE,this.onEvent,this),this.retry<e.maxRetry?(this.retry++,this.dispatcher=e.getDispatcher(this.url,-this.retry),this.dispatcher.once(egret.Event.COMPLETE,this.onEvent,this),this.dispatcher.once(egret.IOErrorEvent.IO_ERROR,this.onError,this)):this.handle=void 0},t.prototype.release=function(){this.handle=void 0,this.dispatcher&&(this.dispatcher.removeEventListener(egret.Event.COMPLETE,this.onEvent,this),this.dispatcher.removeEventListener(egret.IOErrorEvent.IO_ERROR,this.onError,this),this.dispatcher=void 0),this.url&&(e.delRel(this.url),this.url=void 0)},t}();e.Loader=h,__reflect(h.prototype,"RES.Loader");var g=function(){function e(e,t){this.url=e,this.priority=t,this.time=egret.getTimer()}return e}();e.LoadItem=g,__reflect(g.prototype,"RES.LoadItem"),e.lazyLoadMap={},e.lazyLoadList=[],e.asyncLoad=r,e.changePriority=o,e.getDispatcher=n,e.loadingCount=0,e.maxThread=2,e.maxRetry=3,e.using={},e.recycles={},e.addRel=s,e.delRel=a,e.startRecycleTimer=c,e.forceRecycle=p}(RES||(RES={}));var RES;!function(e){var t;!function(e){e.normalize=function(e){var t=e.split("/");return t.filter(function(e,r){return!!e||r==t.length-1}).join("/")},e.basename=function(e){return e.substr(e.lastIndexOf("/")+1)},e.dirname=function(e){return e.substr(0,e.lastIndexOf("/"))}}(t=e.path||(e.path={}))}(RES||(RES={}));var RES;!function(e){function t(){e.config.config.fileSystem.profile(),console.log(r);var t=0;for(var o in r){var n=r[o];n instanceof egret.Texture&&(t+=n.$bitmapWidth*n.$bitmapHeight*4)}console.log("gpu size : "+(t/1024).toFixed(3)+"kb")}var r={};e.profile=t,e.host={state:{},get resourceConfig(){return e.config},load:function(t,r){var o="string"==typeof r?e.processor._map[r]:r;return e.queue.loadResource(t,o)},unload:function(t){return e.queue.unloadResource(t)},save:function(t,o){e.host.state[t.root+t.name]=2,t.promise=void 0,r[t.url]=o},get:function(e){return r[e.url]},remove:function(t){delete e.host.state[t.root+t.name],delete r[t.url]}},e.config=new e.ResourceConfig,e.queue=new e.ResourceLoader;var o=function(e){function t(r,o,n){var i=e.call(this)||this;return i.__resource_manager_error__=!0,i.name=r.toString(),i.message=t.errorMessage[r].replace("{0}",o).replace("{1}",n),i}return __extends(t,e),t.errorMessage={1001:"文件加载失败:{0}",1002:"ResourceManager 初始化失败：配置文件加载失败",1005:"ResourceManager 已被销毁，文件加载失败:{0}",2001:"{0}解析失败,不支持指定解析类型:'{1}'，请编写自定义 Processor ，更多内容请参见 https://github.com/egret-labs/resourcemanager/blob/master/docs/README.md#processor",2002:"Analyzer 相关API 在 ResourceManager 中不再支持，请编写自定义 Processor ，更多内容请参见 https://github.com/egret-labs/resourcemanager/blob/master/docs/README.md#processor",2003:"{0}解析失败,错误原因:{1}",2004:"无法找到文件类型:{0}",2005:"资源配置文件中无法找到特定的资源组:{0}",2006:"资源配置文件中无法找到特定的资源:{0}"},t}(Error);e.ResourceManagerError=o,__reflect(o.prototype,"RES.ResourceManagerError")}(RES||(RES={}));var RES;!function(e){var t;!function(t){function r(e){return t._map[e.type]}function o(e,r){t._map[e]=r}function n(t,r){var o=this;return new Promise(function(n,i){var s=function(){var e=t.data?t.data:t.response;n(e)},a=function(){var t=new e.ResourceManagerError(1001,r.url);i(t)};t.addEventListener(egret.Event.COMPLETE,s,o),t.addEventListener(egret.IOErrorEvent.IO_ERROR,a,o)})}function i(e,t){if(-1!=t.indexOf("://"))return t;e=e.split("\\").join("/");var r=e.match(/#.*|\?.*/),o="";r&&(o=r[0]);var n=e.lastIndexOf("/");return e=-1!=n?e.substring(0,n+1)+t:t,e+o}t.isSupport=r,t.map=o,t.getRelativePath=i,t.ImageProcessor={onLoadStart:function(t,r){var o=new egret.ImageLoader;return o.load(e.getVirtualUrl(r.root+r.url)),n(o,r).then(function(e){var o=new egret.Texture;o._setBitmapData(e);var n=t.resourceConfig.getResource(r.name);if(n&&n.scale9grid){var i=n.scale9grid.split(",");o.scale9Grid=new egret.Rectangle(parseInt(i[0]),parseInt(i[1]),parseInt(i[2]),parseInt(i[3]))}return o})},onRemoveStart:function(e,t){var r=e.get(t);r.dispose()}},t.BinaryProcessor={onLoadStart:function(t,r){var o=new egret.HttpRequest;return o.responseType=egret.HttpResponseType.ARRAY_BUFFER,o.open(e.getVirtualUrl(r.root+r.url),"get"),o.send(),n(o,r)},onRemoveStart:function(e,t){}},t.TextProcessor={onLoadStart:function(t,r){var o=new egret.HttpRequest;return o.responseType=egret.HttpResponseType.TEXT,o.open(e.getVirtualUrl(r.root+r.url),"get"),o.send(),n(o,r)},onRemoveStart:function(e,t){return!0}},t.JsonProcessor={onLoadStart:function(e,t){return e.load(t,"text").then(function(e){var t=JSON.parse(e);return t})},onRemoveStart:function(e,t){}},t.XMLProcessor={onLoadStart:function(e,t){return e.load(t,"text").then(function(e){var t=egret.XML.parse(e);return t})},onRemoveStart:function(e,t){return!0}},t.CommonJSProcessor={onLoadStart:function(t,r){return t.load(r,"text").then(function(t){var o=new Function("require","exports",t),n=function(){},i={};try{o(n,i)}catch(s){throw new e.ResourceManagerError(2003,r.name,s.message)}return i})},onRemoveStart:function(e,t){}},t.SheetProcessor={onLoadStart:function(e,t){return e.load(t,"json").then(function(r){var o=i(t.name,r.file),n=e.resourceConfig.getResource(o);return n||(n={name:o,url:o,type:"image",root:t.root}),e.load(n).then(function(t){e.state[n.root+n.name]=0;var o=r.frames,i=new egret.SpriteSheet(t);i.$resourceInfo=n;for(var s in o){var a=o[s],u=i.createTexture(s,a.x,a.y,a.w,a.h,a.offX,a.offY,a.sourceW,a.sourceH);if(a.scale9grid){var c=a.scale9grid,l=c.split(",");u.scale9Grid=new egret.Rectangle(parseInt(l[0]),parseInt(l[1]),parseInt(l[2]),parseInt(l[3]))}}return e.save(n,i),i})})},getData:function(t,r,o,n){var i=t.get(r);return i?i.getTexture(e.nameSelector(n)):null},onRemoveStart:function(e,t){var r=e.get(t),o=r.$resourceInfo;r.dispose(),e.unload(o)}};var s=function(e,t){var r="",o=t.split("\n"),n=o[2],i=n.indexOf('file="');-1!=i&&(n=n.substring(i+6),i=n.indexOf('"'),r=n.substring(0,i)),e=e.split("\\").join("/");var i=e.lastIndexOf("/");return e=-1!=i?e.substring(0,i+1)+r:r};t.FontProcessor={onLoadStart:function(e,t){return e.load(t,"text").then(function(r){var o;try{o=JSON.parse(r)}catch(n){o=r}var a;a="string"==typeof o?s(t.url,o):i(t.url,o.file);var u=e.resourceConfig.getResource(a);return u||(u={name:a,url:a,type:"image",root:t.root}),e.load(u).then(function(t){e.state[u.root+u.name]=0;var r=new egret.BitmapFont(t,o);return r.$resourceInfo=u,e.save(u,t),r})})},onRemoveStart:function(e,t){var r=e.get(t),o=r.$resourceInfo;e.unload(o)}},t.SoundProcessor={onLoadStart:function(t,r){var o=new egret.Sound;return o.load(e.getVirtualUrl(r.root+r.url)),n(o,r).then(function(){return o})},onRemoveStart:function(e,t){}},t.MovieClipProcessor={onLoadStart:function(t,r){var o,n;return t.load(r,"json").then(function(i){o=i;var s=r.name,a=s.substring(0,s.lastIndexOf("."))+".png";if(n=t.resourceConfig.getResource(a,!0),!n)throw new e.ResourceManagerError(1001,a);return t.load(n)}).then(function(e){t.save(n,e),t.state[n.name]=0;var r=e,i=new egret.MovieClipDataFactory(o,r);return i})},onRemoveStart:function(e,t){var r=e.get(t);r.clearCache(),r.$spriteSheet.dispose();var o=t.name,n=o.substring(0,o.lastIndexOf("."))+".png",i=e.resourceConfig.getResource(n,!0);e.unload(i)}},t.MergeJSONProcessor={onLoadStart:function(t,r){return t.load(r,"json").then(function(t){for(var o in t)e.config.addSubkey(o,r.name);return t})},getData:function(e,t,r,o){var n=e.get(t);return n?n[o]:(console.error("missing resource :"+t.name),null)},onRemoveStart:function(e,t){}},t.LegacyResourceConfigProcessor={onLoadStart:function(t,r){return t.load(r,"json").then(function(o){var n=e.config.config,i=r.root,s=n.fileSystem;s||(s={fsData:{},getFile:function(e){return p[e]},addFile:function(e,t,r,o){t||(t=""),void 0==r&&(r=""),p[e]={name:e,type:t,url:e,root:r,extra:o}},profile:function(){console.log(p)},removeFile:function(e){delete p[e]}},n.fileSystem=s);for(var a=n.groups,u=0,c=o.groups;u<c.length;u++){var l=c[u];""==l.keys?a[l.name]=[]:a[l.name]=l.keys.split(",")}for(var f=n.alias,p=s.fsData,h=function(e){p[e.name]=e,p[e.name].root=i,e.subkeys&&e.subkeys.split(",").forEach(function(t){f[t]=e.name+"#"+t,f[e.name+"."+t]=e.name+"#"+t})},g=0,d=o.resources;g<d.length;g++){var v=d[g];h(v)}return t.save(r,n),n})},onRemoveStart:function(){}},t._map={image:t.ImageProcessor,json:t.JsonProcessor,text:t.TextProcessor,xml:t.XMLProcessor,sheet:t.SheetProcessor,font:t.FontProcessor,bin:t.BinaryProcessor,commonjs:t.CommonJSProcessor,sound:t.SoundProcessor,movieclip:t.MovieClipProcessor,mergeJson:t.MergeJSONProcessor,legacyResourceConfig:t.LegacyResourceConfigProcessor}}(t=e.processor||(e.processor={}))}(RES||(RES={}));var RES;!function(e){var t=function(t){function r(e,r,o){void 0===r&&(r=!1),void 0===o&&(o=!1);var n=t.call(this,e,r,o)||this;return n.itemsLoaded=0,n.itemsTotal=0,n.groupName="",n}return __extends(r,t),r.dispatchResourceEvent=function(t,o,n,i,s,a){void 0===n&&(n=""),void 0===i&&(i=void 0),void 0===s&&(s=0),void 0===a&&(a=0);var u=egret.Event.create(r,o);u.groupName=n,i&&(u.resItem=e.ResourceItem.convertToResItem(i)),u.itemsLoaded=s,u.itemsTotal=a;var c=t.dispatchEvent(u);return egret.Event.release(u),c},r.ITEM_LOAD_ERROR="itemLoadError",r.CONFIG_COMPLETE="configComplete",r.CONFIG_LOAD_ERROR="configLoadError",r.GROUP_PROGRESS="groupProgress",r.GROUP_COMPLETE="groupComplete",r.GROUP_LOAD_ERROR="groupLoadError",r}(egret.Event);e.ResourceEvent=t,__reflect(t.prototype,"RES.ResourceEvent")}(RES||(RES={}));var RES;!function(e){var t;!function(t){function r(t){var r=t.name;if(e.config.config)for(var o in e.config.config.alias)e.config.config.alias[o]==t.url&&(r=o);else r=t.url;var n={name:r,url:t.url,type:t.type,data:t,root:t.root};return n}t.TYPE_XML="xml",t.TYPE_IMAGE="image",t.TYPE_BIN="bin",t.TYPE_TEXT="text",t.TYPE_JSON="json",t.TYPE_SHEET="sheet",t.TYPE_FONT="font",t.TYPE_SOUND="sound",t.convertToResItem=r}(t=e.ResourceItem||(e.ResourceItem={}))}(RES||(RES={}));var RES;!function(e){var t=function(){function t(e){this.data=e}return t.prototype.profile=function(){console.log(this.data)},t.prototype.addFile=function(t,r){r||(r=""),t=e.path.normalize(t);var o=e.path.basename(t),n=e.path.dirname(t);this.exists(n)||this.mkdir(n);var i=this.resolve(n);i[o]={url:t,type:r}},t.prototype.getFile=function(e){var t=this.resolve(e);return t&&(t.name=e),t},t.prototype.resolve=function(t){if(""==t)return this.data;t=e.path.normalize(t);for(var r=t.split("/"),o=this.data,n=0,i=r;n<i.length;n++){var s=i[n];if(!o)return o;o=o[s]}return o},t.prototype.mkdir=function(t){t=e.path.normalize(t);for(var r=t.split("/"),o=this.data,n=0,i=r;n<i.length;n++){var s=i[n];o[s]||(o[s]={}),o=o[s]}},t.prototype.exists=function(t){if(""==t)return!0;t=e.path.normalize(t);for(var r=t.split("/"),o=this.data,n=0,i=r;n<i.length;n++){var s=i[n];if(!o[s])return!1;o=o[s]}return!0},t}();e.NewFileSystem=t,__reflect(t.prototype,"RES.NewFileSystem")}(RES||(RES={}));var RES;!function(e){function t(t,r){throw new e.ResourceManagerError(2002)}function r(t,r){if(r.indexOf("://")>=0){var o=r.split("://");r=o[0]+"://"+e.path.normalize(o[1]+"/"),t=t.replace(r,"")}else r=e.path.normalize(r+"/"),t=t.replace(r,"");return e.setConfigURL(t,r),L||(L=new _),L.loadConfig()}function o(e,t,r){return void 0===t&&(t=0),L.loadGroup(e,t,r)}function n(e){return L.isGroupLoaded(e)}function i(t){return L.getGroupByName(t).map(function(t){return e.ResourceItem.convertToResItem(t)})}function s(e,t,r){return void 0===r&&(r=!1),L.createGroup(e,t,r)}function a(e){return L.hasRes(e)}function u(e){return L.getState(e)}function c(e){return L.getRes(e)}function l(e,t,r){return L.getResAsync.apply(L,arguments)}function f(e,t,r,o){void 0===o&&(o=""),L.getResByUrl(e,t,r,o)}function p(e,t){return L.destroyRes(e,t)}function h(t){1>t&&(t=1),e.maxThread=t,L||(L=new _),L.setMaxLoadingThread(t)}function g(t){t=Math.max(t,0),e.maxRetry=t,L.setMaxRetryTimes(t)}function d(e,t,r,o,n){void 0===o&&(o=!1),void 0===n&&(n=0),L||(L=new _),L.addEventListener(e,t,r,o,n)}function v(e,t,r,o){void 0===o&&(o=!1),L.removeEventListener(e,t,r,o)}function m(e){L.addResourceData(e)}function R(){return L||(L=new _),L.vcs}function y(e){L||(L=new _),L.registerVersionController(e)}function E(e){return L.vcs?L.vcs.getVirtualUrl(e):e}e.nameSelector=function(t){return e.path.basename(t).split(".").join("_")},e.registerAnalyzer=t,e.loadConfig=r,e.loadGroup=o,e.isGroupLoaded=n,e.getGroupByName=i,e.createGroup=s,e.hasRes=a,e.getState=u,e.getRes=c,e.getResAsync=l,e.getResByUrl=f,e.destroyRes=p,e.setMaxLoadingThread=h,e.setMaxRetryTimes=g,e.addEventListener=d,e.removeEventListener=v,e.$addResourceData=m,e.getVersionController=R,e.registerVersionController=y,e.getVirtualUrl=E;var _=function(t){function r(){var r=t.call(this)||this;return r.isVcsInit=!1,e.VersionController&&(r.vcs=new e.VersionController),r}return __extends(r,t),r.prototype.registerVersionController=function(e){this.vcs=e,this.isVcsInit=!1},r.prototype.loadConfig=function(){var t=this,r=function(){return e.config.init().then(function(r){e.ResourceEvent.dispatchResourceEvent(t,e.ResourceEvent.CONFIG_COMPLETE)},function(r){return e.ResourceEvent.dispatchResourceEvent(t,e.ResourceEvent.CONFIG_LOAD_ERROR),Promise.reject(r)})};return!this.isVcsInit&&this.vcs?(this.isVcsInit=!0,this.vcs.init().then(function(){return r()})):r()},r.prototype.isGroupLoaded=function(t){var r=e.config.getGroupByName(t,!0);return r.every(function(t){return null!=e.host.get(t)})},r.prototype.getGroupByName=function(t){return e.config.getGroupByName(t,!0)},r.prototype.loadGroup=function(t,r,o){var n=this;void 0===r&&(r=0);var i={onProgress:function(r,i,s){o&&o.onProgress&&o.onProgress(r,i,s),e.ResourceEvent.dispatchResourceEvent(n,e.ResourceEvent.GROUP_PROGRESS,t,s,r,i)}};return this._loadGroup(t,r,i).then(function(r){-1==e.config.config.loadGroup.indexOf(t)&&e.config.config.loadGroup.push(t),e.ResourceEvent.dispatchResourceEvent(n,e.ResourceEvent.GROUP_COMPLETE,t)},function(r){if(-1==e.config.config.loadGroup.indexOf(t)&&e.config.config.loadGroup.push(t),r.itemList)for(var o=r.itemList,i=o.length,s=0;i>s;s++){var a=o[s];delete a.promise,e.ResourceEvent.dispatchResourceEvent(n,e.ResourceEvent.ITEM_LOAD_ERROR,t,a)}return e.ResourceEvent.dispatchResourceEvent(n,e.ResourceEvent.GROUP_LOAD_ERROR,t),Promise.reject(r.error)})},r.prototype._loadGroup=function(t,r,o){void 0===r&&(r=0);var n=e.config.getGroupByName(t,!0);return 0==n.length?new Promise(function(r,o){o({error:new e.ResourceManagerError(2006,t)})}):e.queue.pushResGroup(n,t,r,o)},r.prototype.createGroup=function(t,r,o){return void 0===o&&(o=!1),e.config.createGroup(t,r,o)},r.prototype.hasRes=function(t){return null!=e.config.getResourceWithSubkey(t)},r.prototype.getState=function(t){var r=e.config.getResourceWithSubkey(t);if(r){var o=r.r;return e.host.state[o.root+o.name]}return 0},r.prototype.getRes=function(t){var r=e.config.getResourceWithSubkey(t);if(r){var o=r.r,n=r.key,i=r.subkey,s=e.processor.isSupport(o);return s&&s.getData&&i?s.getData(e.host,o,n,i):e.host.get(o)}return null},r.prototype.getResAsync=function(t,r,o){var n=this,i=t,s=e.config.getResourceWithSubkey(t,!0),a=s.r,u=s.subkey;return e.queue.pushResItem(a).then(function(n){e.host.save(a,n);var s=e.processor.isSupport(a);return s&&s.getData&&u&&(n=s.getData(e.host,a,t,u)),r&&r.call(o,n,i),n},function(t){return e.host.remove(a),e.ResourceEvent.dispatchResourceEvent(n,e.ResourceEvent.ITEM_LOAD_ERROR,"",a),Promise.reject(t)})},r.prototype.getResByUrl=function(t,r,o,n){var i=this;void 0===n&&(n="");var s=e.config.getResource(t);if(!s&&(n||(n=e.config.__temp__get__type__via__url(t)),s={name:t,url:t,type:n,root:"",extra:1},e.config.addResourceData(s),s=e.config.getResource(t),!s))throw"never";return e.queue.pushResItem(s).then(function(t){return e.host.save(s,t),r&&s&&r.call(o,t,s.url),t},function(t){return e.host.remove(s),e.ResourceEvent.dispatchResourceEvent(i,e.ResourceEvent.ITEM_LOAD_ERROR,"",s),Promise.reject(t)})},r.prototype.destroyRes=function(t,r){void 0===r&&(r=!0);var o=e.config.getGroup(t);if(o&&o.length>0){if(r||1==e.config.config.loadGroup.length&&e.config.config.loadGroup[0]==t){for(var n=0,i=o;n<i.length;n++){var s=i[n];e.queue.unloadResource(s)}var a=e.config.config.loadGroup.indexOf(t);e.config.config.loadGroup.splice(a,1)}else{for(var u={},c=0,l=e.config.config.loadGroup;c<l.length;c++){var f=l[c];for(var p in e.config.config.groups[f]){var h=e.config.config.groups[f][p];u[h]?u[h]++:u[h]=1}}for(var h in u)if(u[h]&&1==u[h]){var s=e.config.getResource(h);s&&e.queue.unloadResource(s)}var a=e.config.config.loadGroup.indexOf(t);e.config.config.loadGroup.splice(a,1)}return!0}var s=e.config.getResource(t);return s?e.queue.unloadResource(s):(console.warn("无法删除指定组:"+t),!1)},r.prototype.setMaxLoadingThread=function(t){1>t&&(t=1),e.queue.thread=t},r.prototype.setMaxRetryTimes=function(t){t=Math.max(t,0),e.queue.maxRetryTimes=t},r.prototype.addResourceData=function(t){e.config.addResourceData(t)},__decorate([e.checkNull],r.prototype,"hasRes",null),__decorate([e.checkNull],r.prototype,"getRes",null),__decorate([e.checkNull],r.prototype,"getResAsync",null),__decorate([e.checkNull],r.prototype,"getResByUrl",null),r}(egret.EventDispatcher);e.Resource=_,__reflect(_.prototype,"RES.Resource");var L}(RES||(RES={}));var RES;!function(e){var t=function(){function e(){}return e.prototype.init=function(){return this.versionInfo=this.getLocalData("all.manifest"),Promise.resolve()},e.prototype.getVirtualUrl=function(e){return e},e.prototype.getLocalData=function(e){if(egret_native.readUpdateFileSync&&egret_native.readResourceFileSync){var t=egret_native.readUpdateFileSync(e);if(null!=t)return JSON.parse(t);if(t=egret_native.readResourceFileSync(e),null!=t)return JSON.parse(t)}return null},e}();e.NativeVersionController=t,__reflect(t.prototype,"RES.NativeVersionController",["RES.IVersionController"]),egret.Capabilities.runtimeType==egret.RuntimeType.NATIVE&&(e.VersionController=t)}(RES||(RES={}));